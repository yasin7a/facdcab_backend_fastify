enum SubscriptionTier {
  GOLD
  PLATINUM
  DIAMOND
}

enum BillingCycle {
  MONTHLY
  SIX_MONTHLY
  YEARLY
  LIFETIME
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PENDING
}

model FeatureUsage {
  id              Int      @id @default(autoincrement())
  user_id         Int
  subscription_id Int
  feature_name    String
  usage_count     Int      @default(0)
  period_start    DateTime
  period_end      DateTime
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  user         User         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  subscription Subscription @relation(fields: [subscription_id], references: [id], onDelete: Cascade)

  @@unique([user_id, subscription_id, feature_name, period_start])
  @@index([user_id, feature_name])
  @@index([subscription_id])
  @@index([period_end])
  @@map("feature_usage")
}

model Subscription {
  id Int @id @default(autoincrement())

  user_id       Int
  tier          SubscriptionTier
  billing_cycle BillingCycle
  status        SubscriptionStatus @default(PENDING)
  start_date    DateTime
  end_date      DateTime
  auto_renew    Boolean            @default(true)
  cancelled_at  DateTime?
  trial_end     DateTime? // Trial period end date
  created_at    DateTime           @default(now())
  updated_at    DateTime           @updatedAt

  user     User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  invoices Invoice[]
  usage    FeatureUsage[]

  @@index([user_id])
  @@index([status])
  @@index([end_date])
  @@index([end_date, status])
  @@index([user_id, status])
  @@index([trial_end])
  @@map("subscriptions")
}

model Feature {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  tiers TierFeature[]

  @@map("features")
}

model TierFeature {
  id Int @id @default(autoincrement())

  tier       SubscriptionTier
  feature_id Int
  enabled    Boolean          @default(true)
  limit      Int? // Optional limit for the feature (e.g., API calls per month)
  created_at DateTime         @default(now())
  updated_at DateTime         @updatedAt
  feature    Feature          @relation(fields: [feature_id], references: [id], onDelete: Cascade)

  @@unique([tier, feature_id])
  @@index([tier])
  @@map("tier_features")
}

model SubscriptionPrice {
  id            Int              @id @default(autoincrement())
  tier          SubscriptionTier
  billing_cycle BillingCycle
  price         Decimal          @db.Decimal(10, 2)
  setup_fee     Decimal          @default(0) @db.Decimal(10, 2)
  currency      String
  tax_rate      Decimal          @default(0) @db.Decimal(5, 4)
  active        Boolean          @default(true)
  created_at    DateTime         @default(now())
  updated_at    DateTime         @updatedAt

  region       String? // Geographic pricing
  valid_from   DateTime? // Promotional periods
  valid_until  DateTime?
  discount_pct Int? // Percentage discount
  promo_code   String? // Link to promo campaigns

  @@unique([tier, billing_cycle, currency, region])
  @@index([tier, billing_cycle])
  @@map("subscription_prices")
}
